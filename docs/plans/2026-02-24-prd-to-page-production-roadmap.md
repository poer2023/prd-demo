# PRD -> 页面 生产级落地路线图（全量）

## 1. 目标与范围

**产品目标（单人模式）**
- 输入 PRD（Markdown/结构化要求），输出可运行页面（含交互）与可回归验证结果。
- 支持“根据 PRD 重新生成页面”、对照交互、按 PRD 驱动样式变化。
- 支持版本化追踪与发布前质量闸门。

**明确非目标（当前阶段）**
- 不做多人协作权限系统。
- 不做企业级组织空间/审批流。

## 2. 北极星能力（最终态）

1. `PRD Compiler`: `PRD -> AST -> ProtoSpec` 三段式编译。
2. `ProtoSpec Contract`: 页面结构、交互状态机、样式 Token、追踪映射统一契约。
3. `Runtime Renderer`: 由 ProtoSpec 渲染可运行页面，支持重生成与节点锁定。
4. `Style Engine`: PRD 样式约束映射到 Token，再落 CSS Variables / 主题。
5. `Interaction Trace`: PRD 条款点击高亮组件与状态流，支持交互回放。
6. `Quality Gate`: Schema 校验、交互回放、视觉回归、发布前阻断。

## 3. 阶段划分（A-F）

## Phase A: 架构地基（本次全量完成）

**目标**
- 建立后续 B-F 不返工的基础契约与管线骨架。

**交付物**
1. ProtoSpec 领域模型（类型、版本、校验、错误模型）。
2. PRD 编译管线骨架（Parser/Normalizer/Compiler）。
3. 任务系统骨架（Job、Queue、Worker、状态查询）。
4. 存储抽象层（Repository 接口 + InMemory 实现）。
5. 编译 API（创建编译任务、查询任务、读取产物）。
6. 数据库 schema 草案（PostgreSQL，面向后续落地）。
7. 结构化日志与追踪 ID 基础能力。

**完成标准（DoD）**
- 有端到端链路：提交 PRD 文本 -> 获得任务 -> 查询结果 -> 拿到 ProtoSpec（哪怕是基础版）。
- ProtoSpec 有严格校验与错误返回，不允许静默失败。
- API 以统一响应格式返回，错误码清晰。
- 代码目录明确区分：`domain/compiler/runtime/platform`。

## Phase B: 生成引擎（Compiler 实体化）

**目标**
- 将“骨架编译器”升级为可稳定产出真实页面结构的编译器。

**交付物**
1. PRD 语义提取规则（页面、组件、字段、流程、验收标准）。
2. 约束冲突解析（比如样式和组件能力冲突）。
3. AI 补全过程（仅补全，不直接绕过契约）。
4. 编译置信度与人工确认点机制。

**完成标准**
- 至少 3 类页面模板（表单页、列表页、详情页）可稳定生成。
- 生成结果在同输入下可重复。

## Phase C: 渲染与样式引擎

状态: 已完成（2026-02-24）

**目标**
- ProtoSpec 真正渲染为可运行页面，并支持样式按 PRD 变化。

**交付物**
1. Runtime Renderer（组件白名单 + 插槽）。
2. Token Compiler（色彩、间距、排版、圆角、阴影）。
3. 主题切换与页面级覆盖策略。
4. 节点锁定策略（重生成不覆盖手工节点）。

**完成标准**
- PRD 样式变更可在不改业务代码情况下生效。

## Phase D: 对照交互与可追踪性

状态: 已完成（2026-02-24）

**目标**
- 让“PRD 条款 -> 页面节点/交互节点”可点击、可定位、可回放。

**交付物**
1. 条款映射索引（trace map）。
2. 交互回放器（状态机驱动）。
3. 变更对照（交互 diff + 结构 diff）。

## Phase E: 质量闸门与发布

状态: 进行中（自 2026-02-24）

**目标**
- 提供生产可用的发布前质量保证。

**交付物**
1. Schema Gate。
2. Playwright 交互回归。
3. 视觉回归（截图基线）。
4. 发布流水线（阻断未通过项）。

当前进展:
- 已完成: Schema Gate、traceability gate、interaction replay gate、CI 阻断工作流（`test:all-gates`）。
- 已完成（初版）: Playwright 交互回归与视觉回归脚手架、CI 回归 job。
- 待完成: 视觉 baseline 治理策略（固定基线库与评审流程）、更多关键路径用例。

## Phase F: 现有内容迁移与收敛

**目标**
- 把当前手写页面逐步收敛到 ProtoSpec 驱动。

**交付物**
1. C2ME 页面迁移。
2. EssayPass 页面迁移。
3. 旧手写映射删除清单与退场计划。

## 4. 依赖关系（防忘机制）

- B 依赖 A 的 `ProtoSpec` 与 `Compiler API`。
- C 依赖 B 的稳定 ProtoSpec 输出。
- D 依赖 B/C 的节点 ID 与状态机 ID 稳定性。
- E 依赖 C/D 的可执行产物与可追踪映射。
- F 依赖 A-E 全部完成后逐页切换。

> 约束：不得在 B 阶段直接绕过 A 的契约设计做“临时代码生成”。

## 5. 风险与应对

1. **风险**: PRD 自由文本过于松散，编译不稳定。  
   **应对**: 强制 PRD 规范块（页面目标、交互流程、验收标准）并做缺失提示。

2. **风险**: AI 输出不稳定导致结构抖动。  
   **应对**: AI 仅补全字段，最终必须通过 ProtoSpec 校验器。

3. **风险**: 页面重生成覆盖手工改动。  
   **应对**: 节点锁定 + merge 策略 + 冲突提示。

4. **风险**: 演示效果好但不可回归。  
   **应对**: E 阶段前不允许标记“可发布”。

## 6. 里程碑与检查点

- M1（A 完成）: 有可调用编译任务 API，返回有效 ProtoSpec。
- M2（B 完成）: 三类页面 PRD 可稳定生成。
- M3（C 完成）: 样式由 PRD 驱动且可热切换。
- M4（D 完成）: 条款点击可定位组件并回放交互。
- M5（E 完成）: 发布有质量闸门阻断。
- M6（F 完成）: C2ME + EssayPass 主路径迁移收敛。

## 7. 本轮执行约束

- 当前轮次只执行 **Phase A 全量**，不把 B/C 的逻辑硬塞进 A。
- 但 A 的接口命名和数据模型必须以 B/C/D 为导向，避免返工。
